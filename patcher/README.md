# CoOpt UI Patcher

Desktop application that updates **CoOpt UI project files only** (ItemUI, ScriptTracker, macros, resources) in your MacroQuest root. It validates that you are in an MQ root, fetches a release manifest, compares local files by hash, and downloads only changed CoOpt UI files via raw GitHub URLs.

## Requirements

- Python 3.10+
- Windows (MacroQuest is Windows-only)

## Run from source

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```
2. Run the patcher **from your MacroQuest root directory** (the folder that contains `MacroQuest.exe` or `config/`):
   ```bash
   cd C:\path\to\your\MacroQuest
   python path\to\patcher\patcher.py
   ```
   Or run from the `patcher` folder and set your working directory to the MQ root first.

If the app is not run from a valid MQ root, it will show an error in the status area and disable the Patch button.

## Build a single .exe (PyInstaller) with CooptGaming logo

1. **Install dependencies** (includes PyInstaller and Pillow):
   ```bash
   cd C:\path\to\repo\patcher
   pip install -r requirements.txt
   ```

2. **Create the .exe icon** from the CooptGaming banner (so the exe file and window use the logo):
   ```bash
   python build_icon.py
   ```
   This generates `assets/icon.ico` from `assets/banner.png`. You only need to run this once (or when you change the logo).

3. **Build the executable**:
   ```bash
   pyinstaller patcher.spec
   ```

4. **Output:** The single-file executable is at:
   ```
   patcher\dist\CoOptUIPatcher.exe
   ```

5. Copy `CoOptUIPatcher.exe` to your MacroQuest root and run it from there. The exe must be run from the MQ root so it can validate the directory and write updated CoOpt UI files. The CooptGaming logo will appear as the exe icon in Explorer and in the window title bar when the patcher runs.

## Manifest schema

The patcher fetches `release_manifest.json` from the repo (at repo root by default). Schema:

```json
{
  "version": "1.0.0",
  "files": [
    { "path": "lua/itemui/init.lua", "hash": "<sha256 hex>" },
    ...
  ]
}
```

- `path`: relative path from repo root, forward slashes.
- `hash`: SHA256 hex digest of the file contents. The patcher compares this to the local file and downloads only when different.

The local template is `patcher/release_manifest.json`. The **live** manifest used by the patcher is at the repository root and is generated by `patcher/generate_manifest.py` (run from repo root: `python patcher/generate_manifest.py`). Regenerate the manifest when cutting a release so hashes match the published files.

## When do users get updates?

The patcher **only** offers files (and versions) that are listed in the manifest. It does not scan the repo for changes.

- **During development:** Edit and push code as often as you like. As long as you **do not** update and push `release_manifest.json`, the manifest in the repo still has the old hashes, so the patcher will not offer any new content to users.
- **When you are ready for a release:** From the repo root (with the code you want to release), run `python patcher/generate_manifest.py`, then commit and push the new `release_manifest.json` (and your code) to the branch the patcher uses. After that, the patcher will see the new hashes and offer those files as updates.

So: the patcher only "knows" which files to get from the manifest, and it only offers a new release when you regenerate and push that manifest.

## Default config (create-if-missing)

The patcher also fetches `default_config_manifest.json`, which lists default INI files under `config_templates/` (sell_config, shared_config, loot_config). For each entry, if the file **does not exist** in the user's `Macros/` folder, the patcher downloads it from the repo and writes it. Existing user files are **never overwritten**. Regenerate the default config manifest when you add or remove template files (from repo root: `python patcher/generate_default_config_manifest.py`), then commit and push `default_config_manifest.json`.

## Configuration

Repo URL and manifest path are set in `patcher.py`:

- `REPO_BASE_URL`: raw GitHub base URL (e.g. `https://raw.githubusercontent.com/owner/repo/main`).
- `MANIFEST_PATH`: path to the manifest file in the repo (default `release_manifest.json`).

Change these to point at a different repository or branch if needed.
